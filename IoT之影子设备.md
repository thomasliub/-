# 影子设备

# 1. 影子设备功能
设备泛指IoT平台管理的物理设备。影子设备和设备是一对一的关系，指在IoT平台内部，设备的替身，其包括设备状态和设备控制。

## 1.1 维护设备状态
设备状态，分为两大类，设备运维状态和设备数据状态。

设备运维状态是指设备的各种OAM状态，包括当前软件版本，在线状态，心跳状态，告警状态等等，是从设备运维管理角度看，系统维护的各种状态。设备运维状态一般原则是只读的。

设备数据状态是指从设备业务角度看，系统维护的各种应用数据，即设备数据项。
设备数据项操作权限分为只读和读写。只读数据项只允许设备主动上报或者由IoT平台主动查询。读写数据项允许设备主动上报，IoT平台主动查询和IoT平台主动更新。

## 1.2 执行设备控制
设备控制，指用户或系统发起的对一台或多台设备执行的控制操作。如，执行读取/更新设备数据项命令，执行设备复位命令，执行设备软件更新命令，等等，还包含应用自定义的命令。


## 1.3 影子设备实现原理
用户或系统对设备的查询或操作请求，首先被提交到影子设备，再由影子设备按照如下策略执行：

* 对于查询设备状态请求，则直接查询影子设备状态并返回
* 对于更新设备数据状态和执行设备命令请求，分如下两种情况：
    * 当设备在线时，立即执行
    * 当设备离线时，建立更新设备数据状态记录或执行设备命令记录。待设备登录后，再执行。 

# 2. 影子设备的主要流程
## 2.1 维护设备的当前状态，包括设备运维状态和设备数据状态  
用户对设备状态的查询可以用直接查询影子设备的状态来实现，影子设备的状态是设备最新状态的真实记录，但不能保证和设备的当前状态严格一致。

1. 设备更新运维状态和数据状态，IoT平台更新影子设备状态，影子设备状态持久化， 例如到 Redis
2. 用户或系统查询设备状态  
3. IoT平台读取影子设备状态并响应用户或系统查询

## 2.2 用户或系统请求变更设备数据状态  
用户可以更新设备的可读写数据状态，并得到更新确认。

1. 用户请求更新设备数据状态，IoT平台通知影子设备执行更新设备数据状态操作  
2. 影子设备执行更新设备数据状态到设备  
    1. 对于在线设备，立即执行
    2. 对于离线设备，建立更新设备数据状态记录（记录状态为“等待执行”），等待设备登录并执行更新设备数据状态后，更新记录状态为“已执行”
3. 设备发布数据项更新，IoT平台更新影子设备数据状态（更新记录状态为“已确认”）  
4. 影子设备给用户确认设备数据状态变更结果  
  
## 2.3. 用户请求执行设备控制操作
用户可以对设备执行控制操作，并得到确认。

1. 用户请求执行设备操作命令，IoT平台通知影子设备执行设备操作命令  
2. 影子设备执行设备操作命令  
    1. 对于在线设备，立即执行
    2. 对于离线设备，建立执行设备操作命令记录（记录状态为“等待执行”），等待设备登录并执行操作命令后，更新记录状态为“已执行”
3. 设备发布操作命令执行结果，IoT平台更新记录状态为“已确认” 
4. 影子设备给用户确认设备操作命令执行结果 
